window.app=window.app||{},app.api_endpoint=function(e){return(e=e||{}).url=e.url||"",e.url=app.site_root()+e.url,$.ajax(e)},function(){var e={};app.controller=function(a,t){e[a]=t},app.bind_controllers=function(){$controlled=$("[data-controller]"),$controlled.each(function(a,t){$elem=$(t);var n=$elem.attr("data-controller");e[n]($elem)})}}(),function(){var e=app.api_endpoint;$.fn.ajaxify=function(a){var t,n,o,r;t=(a=a||{}).on_validate||function(){return!0},n=a.on_send||function(){},o=a.on_result||function(){},r=a.on_error||function(){};var i=$(this);if(i.is("form"))return i.addClass("ajaxified"),i.submit(function(a){var s,l,c;a.preventDefault(),s=i.attr("method"),l=i.attr("action"),c=(c=$("input,textarea,select",i)).not("input[type=submit],input[type=radio]:not(:checked),input[type=checkbox]:not(:checked)");for(var p={},d=0;d<c.length;d++){var u,m;m=(u=$(c[d])).val(),p[u.attr("name")]=m}var f=t(p);if(!0===f){n(i);var g=window.setTimeout(function(){i.addClass("waiting")},500);e({url:l,method:s,data:p}).then(function(e){window.clearTimeout(g),i.removeClass("waiting"),o(e),i.addClass("finished"),window.setTimeout(function(){i.removeClass("finished")},3e3)}).catch(function(e){r(e),i.addClass("error"),window.setTimeout(function(){i.removeClass("error")},3e3)})}else{var _=f.err_message||"form invalid";console.error(_)}}),this;console.error("ajaxify must be called on a form")}}(),function(){var e=app.api_endpoint;$.fn.aggregate=function(a){a=a||{};var t,n,o,r,i,s,l=$(this);function c(a){if(null!==(a=a||null))return o(a),void r(a);console.log(t,n),null!==t&&e({url:t,method:"GET",data:"function"==typeof n?n():n}).then(function(e){o(e),r(e)}).catch(function(e){console.error(e)})}return t=a.source||null,n=a.params||{},i=a.record_template||function(){return $("<div>")},s=a.no_record_msg||"<p>Nothing available at this time</p>",o=a.on_load||function(e){e=e||[],l.empty(),e.length||l.append("function"==typeof s?s():s),console.log(e);for(var a=0;a<e.length;a++){var t=e[a],n=i(t);l.append(n)}},r=a.after_load||function(e){},pagination=a.pagination||!1,pagination&&(on_paginate=a.on_paginate||function(){},on_next=a.on_next||function(){},on_prev=a.on_prev||function(){}),c(),this.reload_records=c,$(this)}}(),$.fn.image_loader=function(e){e=e||{},max_size=e.max_size||15e6,min_size=e.min_size||5e3,max_images=e.max_images||12,accept=e.accept||["image/jpg","image/jpeg","image/png"];var a=$(this);a.is("input")&&"file"==a.attr("type")||console.error("image_loader can only be used on input");var t=a.attr("name"),n=$("label[for="+t+"]"),o=$("<div>").attr({class:"image-loader-wrapper"}),r=$("<div>").attr({class:"image-loader-display"});function i(e){console.error(e);var a=$("<div>").attr({class:"form-prompt error"});a.text(e),n.after(a),window.setTimeout(function(){a.fadeOut(3e3,a.remove)},5e3)}function s(e){return e>=1e6?e/1e6+"mb":e/1e3+"kb"}r.aggregate({record_template:function(e){var a=$("<div>").attr({class:"image-wrapper"}),t=$("<img>"),n=new FileReader;return n.onload=function(e){t.attr("src",e.target.result)},n.readAsDataURL(e),a.append($("<div>").append(t)),a},no_record_msg:"<p>No images</p>"}),n.click(function(){a.click()}),a.change(function(){var e=a.prop("files");if(e.length>max_images)i(["A maximum of "+max_images+" is allowed.","You have chosen "+e.length+"."].join(" "));else{console.log(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.index=t,-1==accept.indexOf(n.type))return void i(n.name+" is not of a supported type");if(n.size>max_size)return void i([n.name+" is too large, max. size is ",s(max_size)+". "+n.name,"is "+s(n.size)+"."].join(" "))}r.reload_records(e)}});var l=$("<div>").attr({class:"form-prompt"});return l.text(["A maximum of "+max_images+" is allowed. Supported types are",accept.map(function(e){return"."+e.split("/")[1]}).join(" ")+". each file must be under",s(max_size)+"."].join(" ")),a.wrap(o),a.before(r),a.after(n),n.after(l),a},function(){function e(e){var a,t,n,o,r,i,s;return o=e.name||"",r=e.value||"",field_class=e.field_class||"",i=!1!==e.has_label,t=$("<div>").attr({class:"field-wrapper "+o}),i&&(s=e.label||o.replace("_"," "),n=$("<span>").attr({class:"label "+o}).text(s),t.append(n)),a=$("<span>").attr({class:["field",o,field_class].join(" ")}).text(r),t.append(a),t}app.templates={field:e,modal:function(e){var a,t,n,o,r=e.message||"";return a=e.on_confirm||function(){},t=e.on_cancel||null,n=e.confirm_text||"Ok",o=e.cancel_text||"Cancel",$modal=$("<div>").attr({class:["modal",modal_class].join(" ")}),$message=$("<div>").text(r),$confirm=$('<button class="confirm">').text(n),$confirm.on_click(function(){$modal.addClass("finished"),a(),window.setTimeout(function(){$modal.remove()},3e3)}),$modal.append($message,$confirm),t&&($cancel=$('<button class="cancel">').text(o),$cancel.on_click(function(){$modal.addClass("finished"),t(),window.setTimeout(function(){$modal.remove()},3e3)}),$modal.setTimeout(function(){$modal.addClass("loaded")},0),$modal.append($cancel)),$modal},listing:function(a){var t,n,o,r=a.status,i=$('<div class="record listing">').addClass(r);t=e({name:"title",value:a.title,has_label:!1}),(n=$("<a>").attr({href:app.site_root()+"/listing/"+a.id})).append(t),$type=e({name:"type",value:{auction:"Auction",buy_now:"Buy Now"}[a.type],has_label:!1});var s=+a.bitcoin?"bitcoin":"dollars";a.ask=+a.ask,"dollars"==s&&(a.ask=a.ask.toFixed(2)),ask_labels={auction:"Ask",buy_now:"Price"},o=e({name:"ask",label:ask_labels[a.type],value:a.ask,field_class:s});var l=e({name:"status",value:{active:"Available",not_started:"Not Started",ended:"Ended",sold:"Sold"}[a.status],css_class:a.status}),c=app.date_format_short(),p=moment(a.start).format(c),d=e({name:"start",label:moment(a.start).isSameOrBefore(moment(new Date))?"started":"starts",value:p}),u=moment(a.end).format(c),m=e({name:"end",label:moment(a.end).isSameOrBefore(moment(new Date))?"ended":"ends",value:u});return i.append(n,o,l,d,m,$type),i},bid:function(a){var t=$("<div>").attr({class:"record bid"}),n=a.offer||"",o=e({name:"offer"}).text(n),r=app.date_format_short(),i=e({name:"date-created",has_label:!1,value:moment(a.date_created).format(r)});return t.append(o,i),t},error:function(e){var a=(e=e||{}).message,t=$('<div class="error">');return t.text(a),window.setTimeout(function(){t.slideUp(1e3,function(){t.remove()})},5e3),t}}}(),$(app.bind_controllers),$(function(){window.setTimeout(function(){$(".flash-message, .message.error").slideUp()},5e3)}),app.controller("view-listing",function(e){$bid_form=$("form.bid.create",e);var a=$("h4 > .field.ask",e);function t(e){if(!e.errors&&e.success){var t=e.new_ask;a.text(t)}else{var n=e.errors||{};for(var o in n){var r=app.templates.error({message:n[o].pop()});$bid_form.prepend(r)}}}if($bid_form.length&&$bid_form.ajaxify({on_result:t}),a.hasClass("bitcoin")){var n=$("<h5>").addClass("conversion"),o=$('<span class="waiting">');window.setInterval(function(){$.ajax("https://api.coindesk.com/v1/bpi/currentprice.json").then(function(e){e=e||{};var t=(((e=JSON.parse(e)).bpi||{}).USD||{}).rate,n=Number(t.replace(",","")),r=Number(a.text());o.removeClass("waiting"),o.addClass("dollars"),o.text(n*r)})},5e3),a.after(n),n.append("Current price in USD: ",o)}}),app.controller("create-listing",function(e){var a=$("form.create-listing",e);$("input.image-loader",a).image_loader()}),app.controller("update-listing-form",function(e){var a=app.templates.modal;$("form.update-listing",e).ajaxify({on_result:function(e){e.success&&(window.location=app.site_root()+"/listing/"+e.id),$("body").append(a({message:e.errors.pop()}))}})}),app.controller("delete-listing-form",function(e){$("form.delete-listing",e).ajaxify({on_result:function(e){e.success&&(window.location=app.site_root()+"/account")}})}),app.controller("listing-search",function(e){var a,t=app.templates.listing,n=$(".aggregate.listing",e),o=$("form.listing-search",e),r={};function i(){o.submit()}$("input,select",o).not("input[type=submit]").each(function(e,a){console.log(a);var t,n,o=$(a);t=o.attr("name"),n=o.val(),r[t]=n}),n.aggregate({source:"/listing/search",params:r,record_template:t}),o.ajaxify({on_result:n.reload_records}),$("input.keyword",o).keyup(function(){window.clearTimeout(a),a=window.setTimeout(function(){i()},1e3)}),$("select.sort_by",o).change(i),$("select.sort_ord",o).change(i)}),app.controller("home-page",function(e){var a,t,n=app.templates.listing,o=$(".aggregate.recently-sold",e);a=moment(new Date),t=moment(new Date).add(7,"days");var r=app.date_format();o.aggregate({source:"/listing/search",params:{start:a.format(r),end:t.format(r),limit:50,status:"sold"},record_template:n}),$(".aggregate.new-listing",e).aggregate({source:"/listing/search",params:{start:a.format(r),end:t.format(r),limit:50,status:"active"},record_template:n})}),app.controller("payment-form",function(e){var a=$("form.payment",e);a.ajaxify({on_result:function(e){e.success?window.location=e.redirect:console.error(e)}});var t,n,o,r,i,s,l,c,p=$("input#same_as_billing",a);t=$("input#billing_street"),n=$("input#billing_city"),o=$("input#billing_state"),r=$("input#billing_zip"),i=$("input#shipping_street"),s=$("input#shipping_city"),l=$("input#shipping_state"),c=$("input#shipping_zip"),p.change(function(){if(p[0].checked)return i.val(t.val()),s.val(n.val()),l.val(o.val()),void c.val(r.val());i.val(""),s.val(""),l.val(""),c.val("")})}),app.controller("user-edit-form",function(e){e.ajaxify({on_result:function(e){}})}),app.controller("user-delete-form",function(e){e.ajaxify({on_result:function(e){e.success&&(window.location=app.site_root())}})}),app.controller("user-profile",function(e){var a=app.templates.listing;$(".aggregate.recently-sold",e),user_listings_aggregate=$(".aggregate.user-created.listing",e);var t=user_listings_aggregate.attr("data-user"),n=app.date_format();user_listings_aggregate.aggregate({source:"/listing/search",params:{seller_id:t,start:moment(new Date(0)).format(n)},record_template:a})});